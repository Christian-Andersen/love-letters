<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Love Letters — Notes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Roboto+Slab:wght@300;400&display=swap" rel="stylesheet">
  <style>
    :root{--paper:#f6efe6;--ink:#2b1f17;--accent:#8b0000}
    html,body{height:100%;margin:0;background:radial-gradient(circle at 10% 10%, #efe6d6 0%, #eadfcf 10%, #e6d8c9 30%, #dcd0c1 60%);font-family:Roboto Slab, serif;color:var(--ink)}
    .wrap{max-width:1000px;margin:32px auto;padding:28px;background:linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.45));box-shadow:0 10px 30px rgba(0,0,0,0.2);border-radius:8px}
    header{display:flex;align-items:center;gap:16px}
    .logo{width:92px;height:92px;background:linear-gradient(180deg,#f7efe0,#efe2cf);border-radius:6px;padding:10px;box-shadow:inset 0 2px 6px rgba(0,0,0,0.05)}
    .logo h1{font-family:Caveat, cursive;margin:0;color:var(--accent);font-size:20px}
    h2{margin:0;font-weight:400}
    .layout{display:grid;grid-template-columns:320px 1fr;gap:20px;margin-top:20px}

    /* Notes list */
    .list{background:var(--paper);padding:12px;border-radius:6px;height:70vh;overflow:auto;border:1px solid rgba(0,0,0,0.06)}
    .note-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:6px;margin-bottom:8px;cursor:pointer;transition:transform .12s,box-shadow .12s}
    .note-item:hover{transform:translateY(-2px);box-shadow:0 6px 14px rgba(0,0,0,0.08)}
    .note-thumb{width:44px;height:44px;background:#fff;border-radius:4px;display:flex;align-items:center;justify-content:center;font-family:Caveat;color:var(--accent);font-size:18px;border:1px dashed rgba(0,0,0,0.06)}
    .note-meta{flex:1}
    .note-title{font-family:Caveat;font-size:16px;margin-bottom:2px}
    .note-sub{font-size:12px;color:#6b5650}
    .read{opacity:.45}

    /* notification */
    .badge{width:12px;height:12px;border-radius:50%;background:var(--accent);box-shadow:0 0 8px rgba(139,0,0,0.6);margin-left:6px}

    /* Viewer */
    .viewer{background:linear-gradient(180deg,#fffafa,#fffefc);padding:22px;border-radius:6px;min-height:70vh;border:1px solid rgba(0,0,0,0.06);overflow:auto}
    .paper{background:repeating-linear-gradient(0deg, transparent 0 36px, rgba(0,0,0,0.01) 36px 37px);padding:26px;border-radius:4px}
    .paper h1{font-family:Caveat;font-size:28px;margin:4px 0}
    .paper .meta{font-size:13px;color:#6b5650;margin-bottom:14px}
    .paper .content{font-size:16px;line-height:1.6;white-space:pre-wrap}

    .controls{display:flex;gap:8px;align-items:center}
    .btn{background:transparent;border:1px solid rgba(0,0,0,0.08);padding:8px 12px;border-radius:6px;cursor:pointer}

    footer{margin-top:18px;font-size:13px;color:#5e4f47}

    @media(max-width:880px){.layout{grid-template-columns:1fr} .list{height:36vh} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo"><h1>From<br>The<br>Front</h1></div>
      <div>
        <h2>Love Letters</h2>
        <div style="color:#6b5650">Click a letter to read.</div>
      </div>
    </header>

    <div class="layout">
      <aside class="list" id="list" aria-label="Notes list">
      </aside>

      <main class="viewer" id="viewer">
        <div class="paper" id="paper">
          <h1>Welcome</h1>
          <div class="meta">Select a note from the left — unread notes glow.</div>
          <div class="content">These are letters recovered and preserved like wartime notes. They will be marked read on your device.</div>
        </div>
      </main>
    </div>
  </div>

  <script>
    const LIST_URL = 'notes/list.json';
    let notesArr = [];

    function basename(filename){
      return filename.replace(/\.\w+$/, '');
    }
    // Use the stem as-is for display (no filename shown)
    function displayName(filename){
      return basename(filename);
    }

    async function loadList(){
      try{
        const res = await fetch(LIST_URL, {cache:'no-store'});
        if(!res.ok) throw new Error('Cannot load manifest');
        notesArr = await res.json();
        notesArr.sort((a,b)=>basename(a).localeCompare(basename(b)));
        renderList(notesArr);
        // Only handle the hash once on initial load to avoid re-open loops
        if(!window._initialHashHandled){
          window._initialHashHandled = true;
          handleHashLoad(notesArr);
        }
      }catch(e){
        document.getElementById('list').innerHTML = '<div style="padding:12px;color:#5e4f47">Failed to load notes manifest. Make sure notes/list.json exists.</div>';
      }
    }

    function isRead(name){return localStorage.getItem('read:'+name) === '1'}
    function markRead(name){localStorage.setItem('read:'+name,'1')}

    function renderList(arr){
      const list = document.getElementById('list');
      list.innerHTML = '';
      arr.forEach(fn=>{
        const item = document.createElement('div');
        item.className = 'note-item '+(isRead(fn)?'read':'');
        item.tabIndex = 0;
        const thumb = document.createElement('div'); thumb.className='note-thumb'; thumb.textContent = displayName(fn).slice(0,2).toUpperCase();
        const meta = document.createElement('div'); meta.className='note-meta';
        const title = document.createElement('div'); title.className='note-title'; title.textContent = displayName(fn);
        meta.appendChild(title);
        item.appendChild(thumb); item.appendChild(meta);
        if(!isRead(fn)){
          const badge = document.createElement('div'); badge.className='badge';
          item.appendChild(badge);
          item.style.boxShadow = '0 0 18px rgba(139,0,0,0.18)';
        }
        item.addEventListener('click', ()=>openNote(fn));
        item.addEventListener('keypress', (e)=>{if(e.key==='Enter') openNote(fn)});
        list.appendChild(item);
      })
    }

    async function openNote(fn){
      const url = 'notes/' + fn;
      try{
        const res = await fetch(url, {cache:'no-store'});
        if(!res.ok) throw new Error('Not found');
        const html = await res.text();
        const paper = document.getElementById('paper');
        paper.innerHTML = html;
        markRead(fn);
        // update list UI without re-fetching to avoid flashing
        renderList(notesArr);
        history.replaceState(null,'', '#'+encodeURIComponent(fn));
      }catch(e){
        alert('Failed to load note: '+fn);
      }
    }

    function handleHashLoad(arr){
      const hash = decodeURIComponent(location.hash.slice(1));
      if(hash){
        const found = arr.find(x=>x===hash);
        if(found) openNote(found);
      }
    }

    // When the hash changes (user clicks back/forward), open the matching note without reloading manifest
    window.addEventListener('hashchange', ()=>{
      const h = decodeURIComponent(location.hash.slice(1));
      if(h){
        const found = notesArr.find(x=>x===h);
        if(found) openNote(found);
      }
    });

    loadList();
  </script>
</body>
</html>
